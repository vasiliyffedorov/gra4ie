# Gra4ie

## Описание

Gra4ie — это PHP-приложение для анализа метрик с дашбордов Grafana на предмет аномалий. Аномалии детектируются при выходе значений за пределы коридора, построенного на основе тренда и дискретного преобразования Фурье (DFT). Приложение работает как прокси-сервер, интегрируясь с Grafana через API, и использует кэширование на базе SQLite для оптимизации производительности.

Основные возможности:
- Получение метрик из Grafana.
- Расчет статистических показателей и построение коридоров.
- Детекция аномалий с использованием DFT и трендов.
- Кэширование результатов для ускорения запросов.
- Логирование и мониторинг производительности.

## Требования

- PHP 8.0 или выше.
- Расширения: PDO (для SQLite), curl (для HTTP-запросов).
- Grafana с доступом к API (view-only токен).
- SQLite для кэша (файловая база данных создается автоматически).

## Установка

1. Клонируйте репозиторий:
   ```
   git clone <repository-url>
   cd gra4ie
   ```

2. Скопируйте пример конфигурации:
   ```
   cp config/config.cfg.example config/config.cfg
   ```

3. Установите зависимости (если используются Composer, но в проекте их нет, так что опционально):
   ```
   composer install
   ```

## Конфигурация

Отредактируйте файл `config/config.cfg`:

- `grafana_token`: View-only токен из целевой Grafana.
- `blacklist_boards`: Список ID дашбордов для исключения (чтобы избежать анализа собственных дашбордов и зацикливания).
- `cache_path`: Путь к SQLite-файлу кэша (по умолчанию `./cache.db`).
- `log_level`: Уровень логирования (debug/info/error).

Дополнительно:
- В Grafana добавьте новый источник данных формата Prometheus по адресу `<your-ip>:9093`.
- Сгенерируйте view-only токен для этого источника и запомните ID источника (если нужно для blacklist).

## Запуск

Запустите встроенный PHP-сервер в корневой директории:
```
php -S 0.0.0.0:9093
```

Сервер будет доступен на порту 9093.

## Использование

1. В Grafana добавьте новую панель.
2. Выберите добавленный источник Prometheus (`<your-ip>:9093`).
3. В запросе выберите дашборд из списка.
4. Приложение вернет метрики с наложенным коридором аномалий.

Пример запроса в Grafana: Выберите метрику, и Gra4ie автоматически обработает данные, добавив corridor и anomaly detection.

Для тестирования: Проверьте логи в `./logs/` (если настроено) и кэш в указанном пути.

## Архитектура

- **Входная точка**: `index.php` — обрабатывает HTTP-запросы от Grafana.
- **DI Container**: `app/DI/Container.php` — управление зависимостями.
- **Клиенты**: `app/Clients/GrafanaProxyClient.php` — взаимодействие с Grafana API.
- **Процессоры**: 
  - `StatsCalculator.php` — расчет статистик.
  - `FourierTransformer.php` и `DFTProcessor.php` — DFT для трендов.
  - `CorridorBuilder.php` — построение коридоров.
  - `AnomalyDetector.php` — детекция аномалий.
- **Кэш**: `app/Cache/SQLiteCacheManager.php` — управление кэшем на SQLite.
- **Утилиты**: `Logger.php` — логирование, `PerformanceMonitor.php` — мониторинг.

Приложение использует интерфейсы для абстракции (например, `LoggerInterface.php`, `CacheManagerInterface.php`).

## Вклад в проект

- Форкните репозиторий.
- Создайте ветку для изменений.
- Отправьте pull request.

## Лицензия

MIT License (или укажите актуальную, если есть).
