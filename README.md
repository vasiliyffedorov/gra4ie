# Gra4ie

## Описание

Gra4ie — это PHP-приложение, функционирующее как прокси-сервер между клиентами Prometheus (например, Grafana) и источниками метрик. Оно извлекает временные ряды из дашбордов Grafana через API, анализирует их на предмет аномалий с использованием математических методов (дискретное преобразование Фурье — DFT, линейные тренды, статистические расчеты), строит "коридоры" допустимых значений и детектирует отклонения. Проект оптимизирован для производительности с помощью многоуровневого кэширования на базе SQLite, поддерживает логирование, мониторинг и интеграцию с PSR-16 стандартом кэширования. Основная цель — автоматизированный анализ метрик для выявления аномалий в реальном времени, с возможностью визуализации в Grafana как источника данных Prometheus.

Ключевые возможности:
- **Интеграция с Grafana:** Автоматическое сканирование дашбордов, извлечение панелей с метриками, кэширование списка метрик для быстрого доступа.
- **Анализ данных:** Расчет коридоров аномалий на основе DFT (для выявления периодичностей), линейных трендов, статистик (перцентили, стандартные отклонения). Поддержка автонастройки периодов анализа.
- **Детекция аномалий:** Вычисление интегральных метрик, группировка сегментов аномалий, оценка "опасности" метрик.
- **Кэширование:** SQLite-база для хранения инстансов Grafana, метрик, статистик и DFT-данных. Поддержка PSR-16 интерфейса через адаптер.
- **Производительность и мониторинг:** Встроенный мониторинг запросов, логирование (PSR-3 совместимое), CLI-скрипты для обновления кэша и тестирования.
- **API-совместимость:** Имитация Prometheus API (эндпоинты /api/v1/labels, /api/v1/query_range и т.д.) для интеграции с Grafana как источником данных.
- **Конфигурация:** Гибкие настройки через config.cfg (параметры коридоров, кэша, производительности), поддержка ENV-переопределений для секретов.

## Требования

- PHP 8.0 или выше.
- Расширения: PDO (для SQLite), curl (для HTTP-запросов).
- Grafana с доступом к API (view-only токен).
- SQLite для кэша (файловая база данных создается автоматически).

## Установка

1. Клонируйте репозиторий:
   ```
   git clone <repository-url>
   cd gra4ie
   ```

2. Установите зависимости через Composer:
   ```
   composer install
   ```

3. Настройте конфигурацию: Отредактируйте файл `config/config.cfg` согласно разделу Конфигурация.

## Конфигурация

Отредактируйте файл `config/config.cfg`:

- `grafana_token`: View-only токен из целевой Grafana (или используйте ENV GRAFANA_API_TOKEN).
- `grafana_url`: URL Grafana (или используйте ENV GRAFANA_URL).
- `blacklist_boards`: Список ID дашбордов для исключения (чтобы избежать анализа собственных дашбордов и зацикливания).
- `cache_path`: Путь к SQLite-файлу кэша (по умолчанию `./cache.db`).
- `log_level`: Уровень логирования (debug/info/error).
- `performance.threshold_ms`: Порог производительности (рекомендуется 50–100 мс в проде).
- Параметры коридоров: Настройки для расчета коридоров аномалий, включая пороги, периоды анализа и DFT-параметры.
- Параметры кэша: Настройки TTL, уровней кэширования (L1/L2), путей к базам данных.
- Параметры производительности: Дополнительные пороги мониторинга, автонастройки периодов.

### ENV overrides
Секреты и URL можно переопределять через переменные окружения:
- `GRAFANA_URL`: Переопределяет grafana_url из конфига.
- `GRAFANA_API_TOKEN`: Переопределяет grafana_api_token (не храните токены в VCS).

Дополнительно:
- В Grafana добавьте новый источник данных формата Prometheus по адресу `<your-ip>:9093`.
- Сгенерируйте view-only токен для этого источника и запомните ID источника (если нужно для blacklist).

## API

Gra4ie имитирует Prometheus API для интеграции с Grafana как источником данных. Основные эндпоинты:

- `/api/v1/labels`: Возвращает список доступных меток.
- `/api/v1/query_range`: Выполняет запрос на диапазон временных рядов с анализом аномалий.
- Другие эндпоинты Prometheus API по мере необходимости.

Запросы обрабатываются с аутентификацией (Basic Auth для инстансов Grafana) и возвращают JSON-ответы.

## Подготовка к запуску

Перед первым запуском сервера необходимо обновить кэш метрик Grafana, чтобы избежать запросов к API при каждом обращении:

```
php bin/update_dashboards_cache.php
```

Эта команда загрузит список дашбордов и панелей из Grafana и сохранит их в кэше SQLite. Рекомендуется запускать её периодически (например, раз в день), если дашборды изменяются.

## Запуск

Запустите встроенный PHP-сервер в корневой директории:
```
php -S 0.0.0.0:9093
```

Сервер будет доступен на порту 9093.

## Использование

1. В Grafana добавьте новый источник данных формата Prometheus по адресу `<your-ip>:9093`.
2. Создайте панель и выберите источник данных Gra4ie.
3. В запросе PromQL выберите метрику из доступных (список обновляется через кэш).
4. Gra4ie вернет временные ряды с наложенными коридорами аномалий и детекцией отклонений.

Приложение автоматически анализирует данные, добавляя метрики коридора и аномалий для визуализации в Grafana.

### CLI-скрипты

- `php bin/update_dashboards_cache.php`: Обновляет кэш метрик из Grafana (запускайте периодически).
- `php bin/test_psr_cache.php`: Тестирует функциональность PSR-16 кэша.
- `php bin/check_dangerous_metrics.php`: Проверяет метрики на наличие опасных аномалий.

Для тестирования: Проверьте логи (если настроено) и кэш в указанном пути.

## Тестирование

Проект использует PHPUnit для тестирования ключевых компонентов. Тесты расположены в директории `tests/` и покрывают функциональность классов CorridorBuilder, DFTProcessor, AnomalyDetector и других.

Для запуска тестов:

```
composer test
```

или

```
./vendor/bin/phpunit
```

Тесты включают AutoTunePeriodCalculatorTest.php, DFTProcessorTest.php и другие.

## Архитектура

- **Входная точка**: `index.php` — HTTP-сервер на PHP, обрабатывающий запросы, аутентификацию (Basic Auth для инстансов Grafana), роутинг и JSON-ответы.
- **Dependency Injection**: `app/DI/Container.php` — управление зависимостями, инъекция интерфейсов (Logger, Cache, etc.).
- **Клиенты**: `app/Clients/GrafanaProxyClient.php` — прокси для запросов к Grafana API, парсинг дашбордов, извлечение данных панелей.
- **Процессоры (ядро анализа)**:
  - `CorridorBuilder.php` — главный оркестратор, строит коридоры на основе исторических данных, DFT и трендов.
  - `DFTProcessor.php` — применение DFT для генерации гармоник и восстановления сигналов.
  - `AnomalyDetector.php` — расчет аномалий, перцентилей, интегральных метрик.
  - `StatsCalculator.php` — агрегация статистик, пересчет данных.
  - `StatsCacheManager.php` — управление кэшем статистик с авто-масштабированием.
  - `AutoTunePeriodCalculator.php` — оптимизация периодов анализа на основе DFT.
  - `HistoricalPeriodOptimizer.php` — определение максимальных периодов для метрик.
  - `LinearTrendCalculator.php` — расчет линейных трендов.
  - `FourierTransformer.php` — низкоуровневые преобразования Фурье.
  - `DataProcessor.php` — обработка и интерполяция данных.
- **Кэш-система**: `app/Cache/SQLiteCacheManager.php` и связанные классы (SQLiteCacheDatabase, SQLiteCacheIO, SQLiteCacheMaintenance, etc.) — многоуровневое кэширование (L1/L2), управление TTL, миграции БД. `PsrDftCacheAdapter.php` — адаптер для PSR-16.
- **Интерфейсы**: `app/Interfaces/` — абстракции для CacheManager, Logger, DataProcessor, DFTProcessor, AnomalyDetector, TrendCalculator, GrafanaClient.
- **Утилиты**: `app/Utilities/Logger.php` (PSR-3), `PerformanceMonitor.php` — логирование и замеры производительности.

## Структура проекта

- `app/`: Основной код (Cache, Clients, DI, Formatters, Interfaces, Processors, Utilities).
- `tests/`: PHPUnit-тесты для ключевых классов (AutoTunePeriodCalculatorTest.php, DFTProcessorTest.php, etc.).
- `config/`: config.cfg — плоский INI с вложенными ключами для конфигурации.
- `bin/`: CLI-скрипты для обслуживания (update_dashboards_cache.php, test_psr_cache.php, check_dangerous_metrics.php).
- `examples/`: Скриншоты демонстрации работы.
- Корневые файлы: index.php (HTTP-сервер), composer.json/lock, README.md, .gitignore, php-cs-fixer.dist.php.

## Интеграция PSR-16 для кэша

Система кэша теперь поддерживает стандарт PSR-16 (Simple Cache) через адаптер `App\Cache\PsrDftCacheAdapter`. Это позволяет использовать стандартные интерфейсы PSR-16 для кэширования данных DFT.

### Основные особенности
- **Совместимость**: Оборачивает существующий `SQLiteCacheManager` без изменения схемы БД.
- **Формат ключей**: Ключи в формате `query|labelsJson` (например, `rate(http_requests_total{job="api-server"}[5m])|{"instance":"10.0.0.1:8080","job":"api-server"}`).
- **Сопоставление методов**:
  - `get/set`: Сопоставляется с `loadFromCache/saveToCache`.
  - `has`: Сопоставляется с `checkCacheExists`.
  - `delete`: Частично поддерживается (предупреждение, так как прямое удаление не в оригинальном интерфейсе).
  - `clear`: Использует `cleanupOldEntries(0)`.
- **Инъекция**: Используйте `\Psr\SimpleCache\SimpleCacheInterface` в DI Container.

### Пример использования
```php
$container = new \App\DI\Container($config);
$psrCache = $container->get(\Psr\SimpleCache\SimpleCacheInterface::class);

$key = $query . '|' . json_encode($labels);
$psrCache->set($key, $dftData);
$dftData = $psrCache->get($key);
```

### Тестирование
Запустите `php bin/test_psr_cache.php` для проверки функциональности PSR-16 с примерами DFT данных.

## Вклад в проект

- Форкните репозиторий.
- Создайте ветку для изменений.
- Отправьте pull request.

## Лицензия

MIT License (или укажите актуальную, если есть).
